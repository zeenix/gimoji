# release-plz configuration
# https://release-plz.dev/docs/config

[workspace]
# Use the existing tag naming convention without 'v' prefix.
git_tag_name = "{{ version }}"
git_release_name = "{{ version }}"

# Enable all release features.
git_release_enable = true
git_tag_enable = true
publish = true
# We're not a library.
semver_check = false

# PR configuration.
pr_name = "ğŸ”– Release {{ version }}"

# Changelog configuration for gimoji-based commits.
# See: https://zeenix.github.io/gimoji/
[changelog]

# Changelog header without the default [Unreleased] section.
header = """# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
"""

# Changelog body template.
# Issue refs are separated by "||" delimiter so we can insert period before them.
body = """

## {{ version | trim_start_matches(pat="v") }} - {{ timestamp | date(format="%Y-%m-%d") }}
{% for group, commits in commits | group_by(attribute="group") %}
### {{ group | upper_first }}
{% for commit in commits %}\
{% set first_line = commit.message | split(pat="\n") | first %}\
{% set parts = first_line | split(pat="||") %}\
- {{ parts | first | upper_first | trim | trim_end_matches(pat=".") }}\
{% if commit.breaking %} (**BREAKING**){% endif %}.\
{% if parts | length > 1 %} {{ parts | last }}{% endif %}
{% endfor %}\
{% endfor %}\
"""

# Protect breaking change commits from being filtered out.
protect_breaking_commits = true

# Commit message preprocessors (applied in order).
commit_preprocessors = [
    # Filter out non-latest dependency updates (keep only most recent bump per dependency).
    # Pattern: "â¬†ï¸ *Update <dep> to <version>" - if newer commit updates same dep, skip this.
    # Non-latest commits are prefixed with "ğŸ”–" to trigger the release-commit skip rule.
    { pattern = "^â¬†ï¸ +Update [^ ]+ to ", replace_command = """sh -c '
        msg=$(cat)
        dep=$(echo "$msg" | sed -E "s/^[^ ]+ +Update ([^ ]+) to.*/\\1/")
        latest=$(git log --oneline --all -E --grep="Update $dep to" --format=%H 2>/dev/null \
            | head -1)
        if [ "$COMMIT_SHA" != "$latest" ]; then printf "ğŸ”–"; else printf "%s" "$msg"; fi
    '""" },
    # Remove optional package/mod prefix (e.g., "scripts: ") but keep gimoji emojis.
    # Matches emoji(s) at start, then "word(s): " prefix pattern.
    { pattern = "^([^\\p{L}\\p{N}\\s]+) [\\w, -]+: ", replace = "$1 " },
    # Extract issue refs from commit body using $COMMIT_SHA.
    # Matches: "Fixes #123", "Closes issue #123", "Resolves bug #123", etc.
    # Appends issue ref with "||" delimiter so template can insert period before it.
    { pattern = ".*", replace_command = """sh -c '
        title=$(cat)
        ref=$(git log -1 --format=%b $COMMIT_SHA 2>/dev/null \
            | grep -oE "(Fixes|Closes|Resolves).*#[0-9]+" | grep -oE "#[0-9]+" | head -1)
        if [ -n "$ref" ]; then printf "%s||%s\\n" "$title" "$ref"
        else printf "%s\\n" "$title"; fi
    '""" },
]

# Categorize commits based on gimoji emojis.
# See: https://zeenix.github.io/gimoji/
commit_parsers = [
    # Skip merge commits, release commits, and empty commits (just emojis).
    { message = "^[Mm]erge", skip = true },
    { message = "^ğŸ”–", skip = true },
    { message = "^[\\p{Emoji}\\p{Emoji_Presentation}\\p{Extended_Pictographic}]+$", skip = true },

    # Features.
    { message = "^âœ¨", group = "Added" },
    { message = "^ğŸ‰", group = "Added" },
    { message = "^ğŸ‘·", group = "Added" },

    # Bug fixes.
    { message = "^ğŸ›", group = "Fixed" },
    { message = "^ğŸš‘", group = "Fixed" },
    { message = "^ğŸ©¹", group = "Fixed" },
    { message = "^ğŸ¥…", group = "Fixed" },

    # Performance.
    { message = "^âš¡", group = "Performance" },

    # Documentation.
    { message = "^ğŸ“", group = "Documentation" },
    { message = "^ğŸ’¡", group = "Documentation" },

    # Refactoring/changes.
    { message = "^â™»ï¸", group = "Changed" },
    { message = "^ğŸ¨", group = "Changed" },
    { message = "^ğŸšš", group = "Changed" },
    { message = "^ğŸ”§", group = "Changed" },
    { message = "^ğŸ—ï¸", group = "Changed" },
    { message = "^ğŸ’„", group = "Changed" },

    # Breaking changes/removals.
    { message = "^ğŸ’¥", group = "Breaking" },
    { message = "^ğŸ”¥", group = "Removed" },
    { message = "^ğŸ—‘ï¸", group = "Deprecated" },

    # Dependencies.
    { message = "^â•", group = "Dependencies" },
    { message = "^â–", group = "Dependencies" },
    { message = "^ğŸ“Œ", group = "Dependencies" },
    { message = "^â¬†ï¸", group = "Dependencies" },
    { message = "^â¬‡ï¸", group = "Dependencies" },

    # Security.
    { message = "^ğŸ”’", group = "Security" },

    # Testing.
    { message = "^âœ…", group = "Testing" },
    { message = "^ğŸ§ª", group = "Testing" },

    # CI/Build.
    { message = "^ğŸ‘·", group = "CI" },
    { message = "^ğŸ’š", group = "CI" },

    # Everything else.
    { message = ".*", group = "Other" },
]
